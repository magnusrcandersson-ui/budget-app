<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Magnus Ekonomi &amp; Invest</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    :root{
  /* ===== TRAINIFY PRO (MUCH LIGHTER) ===== */
  --bg:#1e293b;              /* clearly lighter slate */
  --surface:#334155;         /* cards noticeably lighter */
  --surface2:#475569;        /* inner panels */

  --border:rgba(255,255,255,0.18);

  /* Brand */
  --accent:#ff7a00;
  --accent2:#ff9a3d;
  --violet:#a78bfa;
  --violet2:#c4b5fd;
  --cyan:#22d3ee;

  /* Status */
  --green:#22c55e;
  --green2:#16a34a;
  --red:#f87171;
  --blue:#a78bfa;

  /* Text */
  --text:#ffffff;
  --muted:#e2e8f0;
  --dim:#cbd5e1;

  --radius:14px;
}
body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;padding:28px 0 60px}
    .container{width:1040px;max-width:calc(100vw - 32px);margin:0 auto;padding:0 16px;box-sizing:border-box}
    header{text-align:center;margin-bottom:40px}
    header h1{font-size:2.3rem;font-weight:800;letter-spacing:-.6px;background:linear-gradient(135deg,var(--accent),var(--violet2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    header p{color:var(--muted);margin-top:6px;font-size:.88rem}

    /* CARDS */
    .cards{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-bottom:28px}
    @media(max-width:640px){.cards{grid-template-columns:1fr}}
    .card{background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,0)) , var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:24px;position:relative;overflow:hidden;transition:transform .22s ease,box-shadow .22s ease,border-color .22s ease}
.card:hover{transform:translateY(-4px);border-color:rgba(150,160,255,0.34);box-shadow:0 18px 54px rgba(0,0,0,.22),0 0 0 1px rgba(167,139,250,.10),0 16px 48px rgba(255,122,0,.08)}
    .card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px}
    .card.income::before{background:var(--green)}.card.expense::before{background:var(--red)}.card.balance::before{background:var(--blue)}
    .card-icon{font-size:1.5rem;margin-bottom:10px}
    .card-label{font-size:.7rem;font-weight:600;text-transform:uppercase;letter-spacing:1.2px;margin-bottom:6px}
    .card.income .card-label{color:var(--green)}.card.expense .card-label{color:var(--red)}.card.balance .card-label{color:var(--blue)}
    .card-value{font-size:2rem;font-weight:700;letter-spacing:-.5px}
    .card.income .card-value{color:var(--green)}.card.expense .card-value{color:var(--red)}.card.balance .card-value{color:var(--text)}
    .card-value.neg{color:var(--red)!important}
    .card-sub{font-size:.76rem;color:var(--dim);margin-top:5px}

    /* PROGRESS */
    .prog-wrap{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:20px 24px;margin-bottom:28px}
    .prog-header{display:flex;justify-content:space-between;font-size:.8rem;color:var(--muted);margin-bottom:10px;align-items:center}
    .prog-pct{font-weight:700;font-size:.95rem;color:var(--text)}
    .prog-bg{background:var(--surface2);border-radius:99px;height:12px;overflow:hidden}
    .prog-fill{height:100%;border-radius:99px;background:linear-gradient(90deg,var(--accent),var(--green2));transition:width .6s cubic-bezier(.4,0,.2,1)}
    .prog-fill.danger{background:linear-gradient(90deg,#ff9a3d,var(--red))}
    .prog-fill.warn{background:linear-gradient(90deg,#eab308,#ff9a3d)}

    /* FORMS */
    .columns{display:grid;grid-template-columns:1fr 1fr;gap:18px;margin-bottom:28px}
    @media(max-width:720px){.columns{grid-template-columns:1fr}}
    .panel{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden}
    .panel-header{display:flex;align-items:center;padding:18px 20px 14px;border-bottom:1px solid var(--border);font-size:.94rem;font-weight:600;gap:8px}
    .dot{width:9px;height:9px;border-radius:50%;flex-shrink:0}
    .dot-g{background:var(--green)}.dot-r{background:var(--red)}.dot-b{background:var(--blue)}
    .form-body{padding:18px 20px}
    .form-row{display:flex;flex-direction:column;gap:5px;margin-bottom:13px}
    .form-row label{font-size:.7rem;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.7px}
    input,select{background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:10px 13px;color:var(--text);font-family:inherit;font-size:.88rem;width:100%;outline:none;transition:border-color .2s,box-shadow .2s;-webkit-appearance:none}
    input:focus,select:focus{border-color:var(--violet);box-shadow:0 0 0 3px rgba(167,139,250,.18)}
    select option{background:var(--surface2)}
    input.error{border-color:var(--red)!important;animation:shake .3s ease}
    @keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-5px)}75%{transform:translateX(5px)}}
    .btn{width:100%;padding:12px 14px;border:none;border-radius:10px;font-family:inherit;font-size:.92rem;font-weight:700;cursor:pointer;transition:transform .14s ease,filter .14s ease,box-shadow .14s ease,opacity .14s ease;margin-top:4px;letter-spacing:.2px}
    .btn:hover{opacity:.96;transform:translateY(-1px)}.btn:active{transform:translateY(0)}
    .btn-g{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;box-shadow:0 10px 26px rgba(0,0,0,.28)}
.btn-g:hover{filter:brightness(1.05);transform:translateY(-2px)}
.btn-g:active{transform:translateY(0px);filter:brightness(.98)}
    .btn-r{background:linear-gradient(135deg,#ef4444,#dc2626);color:#fff}

    /* BREAKDOWN */
    .breakdown{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:22px 24px;margin-bottom:28px}
    .section-title{font-size:.94rem;font-weight:600;margin-bottom:18px;display:flex;align-items:center;gap:8px}
    .cat-row{display:flex;align-items:center;gap:12px;margin-bottom:13px}
    .cat-name{font-size:.8rem;color:var(--muted);width:115px;flex-shrink:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .cat-bg{flex:1;background:var(--surface2);border-radius:99px;height:9px;overflow:hidden}
    .cat-fill{height:100%;border-radius:99px;transition:width .5s}
    .cat-amt{font-size:.8rem;font-weight:600;width:90px;text-align:right;flex-shrink:0}

    /* TABLE */
    .filter-bar{display:flex;align-items:center;gap:12px;margin-bottom:18px;flex-wrap:wrap}
    .filter-bar label{font-size:.8rem;color:var(--muted);white-space:nowrap}
    .filter-bar input[type=month]{width:auto;max-width:170px}
    .clr-btn{background:var(--surface2);border:1px solid var(--border);color:var(--muted);border-radius:8px;padding:9px 14px;font-size:.8rem;cursor:pointer;font-family:inherit;transition:background .15s;white-space:nowrap}
    .clr-btn:hover{background:var(--border);color:var(--text)}
    .table-wrap{overflow-x:auto}
    table{width:100%;border-collapse:collapse;font-size:.85rem}
    thead th{padding:10px 16px;text-align:left;font-size:.68rem;font-weight:600;text-transform:uppercase;letter-spacing:.9px;color:var(--dim);border-bottom:1px solid var(--border)}
    tbody tr{border-bottom:1px solid var(--border);transition:background .13s}
    tbody tr:last-child{border-bottom:none}
    tbody tr:hover{background:var(--surface2)}
    tbody td{padding:12px 16px;color:var(--muted);vertical-align:middle}
    tbody td:first-child{color:var(--text);font-weight:500}
    .badge{display:inline-flex;align-items:center;padding:3px 10px;border-radius:99px;font-size:.68rem;font-weight:600;white-space:nowrap}
    .badge-income{background:rgba(34,197,94,.12);color:var(--green)}
    .badge-expense{background:rgba(239,68,68,.12);color:var(--red)}
    .amt-i{color:var(--green)!important;font-weight:600}
    .amt-e{color:var(--red)!important;font-weight:600}
    .del{background:none;border:none;color:var(--dim);cursor:pointer;font-size:.9rem;padding:4px 8px;border-radius:5px;transition:color .15s,background .15s;line-height:1}
    .del:hover{color:var(--red);background:rgba(239,68,68,.12)}
    .edit{background:none;border:none;color:var(--dim);cursor:pointer;font-size:.9rem;padding:4px 8px;border-radius:5px;transition:color .15s,background .15s;line-height:1}
    .edit:hover{color:var(--blue);background:rgba(99,102,241,.12)}
    .empty{text-align:center;padding:44px 20px;color:var(--dim);font-size:.84rem}
    .empty-icon{font-size:2.2rem;margin-bottom:10px}
    .toast{position:fixed;bottom:28px;left:50%;transform:translateX(-50%) translateY(60px);background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:12px 22px;font-size:.85rem;font-weight:500;box-shadow:0 8px 32px rgba(0,0,0,.5);transition:transform .3s,opacity .3s;opacity:0;z-index:100;white-space:nowrap}
    .toast.show{transform:translateX(-50%) translateY(0);opacity:1}
    .toast.green{border-color:rgba(34,197,94,.4);color:var(--green)}
    .toast.red{border-color:rgba(239,68,68,.4);color:var(--red)}
    input[type=number]::-webkit-outer-spin-button,input[type=number]::-webkit-inner-spin-button{-webkit-appearance:none}
    input[type=number]{-moz-appearance:textfield}

    /* CHART */
    .chart-wrap{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:22px 24px;margin-bottom:28px}
    .chart-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;flex-wrap:wrap;gap:12px}
    .chart-title{font-size:.94rem;font-weight:600;display:flex;align-items:center;gap:8px}
    .chart-year{display:flex;align-items:center;gap:8px}
    .chart-year-btn{background:var(--surface2);border:1px solid var(--border);color:var(--muted);border-radius:7px;padding:6px 12px;font-size:.8rem;font-weight:600;cursor:pointer;font-family:inherit;transition:background .15s}
    .chart-year-btn:hover{background:var(--border);color:var(--text)}
    .chart-year-label{font-size:.9rem;font-weight:700;color:var(--text);min-width:44px;text-align:center}
    .chart-legend{display:flex;align-items:center;gap:16px;flex-wrap:wrap}
    .legend-item{display:flex;align-items:center;gap:6px;font-size:.76rem;color:var(--muted)}
    .legend-dot{width:10px;height:10px;border-radius:3px;flex-shrink:0}
    .chart-svg-wrap{width:100%;overflow-x:auto;max-width:100%}
    .chart-tooltip{position:fixed;background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:12px 16px;font-size:.82rem;pointer-events:none;opacity:0;transition:opacity .15s;z-index:200;box-shadow:0 8px 32px rgba(0,0,0,.5);min-width:160px}
    .chart-tooltip.show{opacity:1}
    .tt-month{font-weight:700;color:var(--text);margin-bottom:8px;font-size:.88rem}
    .tt-row{display:flex;justify-content:space-between;gap:16px;margin-bottom:4px}
    .tt-label{color:var(--muted)}
    .tt-val{font-weight:600}

    /* MONTH INPUT TABLE */
    .month-input-wrap{margin-top:20px;border-top:1px solid var(--border);padding-top:20px}
    .month-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
    @media(max-width:600px){.month-grid{grid-template-columns:repeat(2,1fr)}}
    .month-cell{background:var(--surface2);border:1px solid var(--border);border-radius:9px;padding:10px 12px;transition:border-color .2s}
    .month-cell:focus-within{border-color:var(--blue)}
    .month-cell-label{font-size:.68rem;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.6px;margin-bottom:5px}
    .month-cell input{background:none;border:none;outline:none;color:var(--text);font-size:.88rem;font-family:inherit;width:100%;padding:0}

    /* LOGIN */
    #loginScreen{position:fixed;inset:0;background:var(--bg);display:flex;align-items:center;justify-content:center;z-index:999;padding:16px}
    .login-box{background:var(--surface);border:1px solid var(--border);border-radius:20px;padding:44px 38px;width:100%;max-width:400px;box-shadow:0 24px 64px rgba(0,0,0,.6)}
    .login-logo{text-align:center;font-size:3rem;margin-bottom:10px}
    .login-title{text-align:center;font-size:1.75rem;font-weight:800;background:linear-gradient(135deg,var(--accent),var(--violet2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-bottom:6px}
    .login-sub{text-align:center;color:var(--muted);font-size:.85rem;margin-bottom:28px}
    .login-err{background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.3);border-radius:8px;padding:10px 14px;color:var(--red);font-size:.84rem;margin-bottom:14px;display:none}
    .logout-btn{background:var(--surface2);border:1px solid var(--border);color:var(--muted);border-radius:8px;padding:8px 16px;font-size:.82rem;font-weight:600;cursor:pointer;font-family:inherit;transition:background .15s}
    .logout-btn:hover{background:var(--border);color:var(--text)}

    /* NAV TABS */
    .tabs-wrap{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:32px;flex-wrap:wrap}
    .tabs{display:flex;gap:4px;background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:5px;width:fit-content}
    .tab{padding:9px 22px;border-radius:8px;font-size:.88rem;font-weight:600;cursor:pointer;border:none;background:none;color:var(--muted);transition:background .2s,color .2s;font-family:inherit}
    .tab.active{background:linear-gradient(135deg,var(--accent),var(--violet));color:#fff}
    .tab-section{display:none}.tab-section.active{display:block}
    
    /* INVEST INFO BADGE */
    .invest-badge{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:12px 24px;display:flex;align-items:center;gap:14px;height:fit-content}
    .invest-badge-icon{font-size:1.6rem;line-height:1}
    .invest-badge-content{display:flex;flex-direction:column;gap:3px}
    .invest-badge-label{font-size:.72rem;font-weight:600;text-transform:uppercase;letter-spacing:.8px;color:#ff7a00;line-height:1}
    .invest-badge-value{font-size:1.3rem;font-weight:700;color:var(--text);line-height:1.1}

    /* INVEST CARDS */
    /* INVEST CARDS - same as budget cards */
    .inv-cards{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-bottom:28px}
    @media(max-width:640px){.inv-cards{grid-template-columns:1fr}}
    .card.invest::before{background:linear-gradient(90deg,#ff7a00,#ff9a3d)}
    .card.inv-val::before{background:var(--blue)}
    .card.inv-gain::before{background:var(--green)}
    .card.inv-loss::before{background:var(--red)}

    /* INVEST TABLE */
    .inv-table-wrap{overflow-x:auto;max-width:100%}
    .inv-table{width:100%;border-collapse:collapse;font-size:.8rem;table-layout:auto}
    .inv-table thead th{padding:8px 10px;text-align:left;font-size:.65rem;font-weight:600;text-transform:uppercase;letter-spacing:.9px;color:var(--dim);border-bottom:1px solid var(--border)}
    .inv-table thead th.num{text-align:right}
    .inv-table tbody tr{border-bottom:1px solid var(--border);transition:background .13s}
    .inv-table tbody tr:last-child{border-bottom:none}
    .inv-table tbody tr:hover{background:var(--surface2)}
    .inv-table tbody td{padding:10px;color:var(--muted);vertical-align:middle}
    .inv-table tbody td.num{text-align:right}
    .inv-table tbody td.name{color:var(--text);font-weight:600;font-size:.92rem}
    .inv-table tbody td.ticker{color:var(--blue);font-size:.78rem;font-family:monospace;font-weight:700}
    .pos{color:var(--green)!important;font-weight:600}
    .neg2{color:var(--red)!important;font-weight:600}
    .neutral{color:var(--muted)!important}
    .pct-badge{display:inline-flex;align-items:center;padding:3px 9px;border-radius:99px;font-size:.72rem;font-weight:700;white-space:nowrap}
    .pct-badge.pos{background:rgba(34,197,94,.12);color:var(--green)}
    .pct-badge.neg{background:rgba(239,68,68,.12);color:var(--red)}
    .pct-badge.zero{background:rgba(148,163,184,.1);color:var(--muted)}

    /* INVEST FORM */

    .btn-gold{background:linear-gradient(135deg,#ff7a00,#d97706);color:#fff}

    /* SPARKLINE */
    .alloc-bar{display:flex;height:8px;border-radius:99px;overflow:hidden;margin-top:8px;gap:2px}
    .alloc-seg{height:100%;border-radius:2px;transition:flex .5s}

    /* SAVINGS & INCOME PANELS */
    .savings-income-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:28px}
    @media(max-width:720px){.savings-income-grid{grid-template-columns:1fr}}
    .savings-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:22px 24px}
    .savings-card .sec-head{display:flex;align-items:center;gap:10px;margin-bottom:16px;font-size:.94rem;font-weight:600}
    .savings-stat{display:flex;justify-content:space-between;align-items:baseline;padding:8px 0;border-bottom:1px solid var(--border)}
    .savings-stat:last-child{border-bottom:none}
    .savings-stat-label{font-size:.8rem;color:var(--muted)}
    .savings-stat-val{font-size:1.05rem;font-weight:700}
    .savings-form{display:flex;gap:8px;margin-top:14px;flex-wrap:wrap}
    .savings-form input{flex:1;min-width:120px}
    .savings-form .btn{width:auto;padding:10px 18px;flex-shrink:0;font-size:.84rem}

    /* STOCK CHART TABS */
    .stock-tabs{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:16px}
    .stock-tab{background:var(--surface2);border:1px solid var(--border);color:var(--muted);border-radius:8px;padding:6px 14px;font-size:.8rem;font-weight:600;cursor:pointer;font-family:inherit;transition:all .2s}
    .stock-tab.active{background:linear-gradient(135deg,var(--accent),var(--violet));color:#fff;border-color:transparent}
    .stock-chart-panel{display:none}.stock-chart-panel.active{display:block}
    .gain-pill{display:inline-flex;align-items:center;gap:5px;padding:3px 10px;border-radius:99px;font-size:.76rem;font-weight:700}
    .gain-pill.pos{background:rgba(34,197,94,.15);color:#22c55e}
    .gain-pill.neg{background:rgba(248,113,113,.15);color:#f87171}
  </style>
</head>
<body>
<!-- LOGIN SCREEN -->
<div id="loginScreen">
  <div class="login-box">
    <div class="login-logo">üí∏</div>
    <div class="login-title">Magnus Ekonomi &amp; Invest</div>
    <p class="login-sub">Logga in f√∂r att forts√§tta</p>
    <div class="login-err" id="loginErr">Fel anv√§ndarnamn eller l√∂senord</div>
    <div class="form-row"><label>ANV√ÑNDARNAMN</label><input type="text" id="loginUser" placeholder="anv√§ndarnamn" autocomplete="username" onkeydown="if(event.key==='Enter')doLogin()"/></div>
    <div class="form-row" style="margin-bottom:20px"><label>L√ñSENORD</label><input type="password" id="loginPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" onkeydown="if(event.key==='Enter')doLogin()"/></div>
    <button class="btn btn-g" onclick="doLogin()">Logga in ‚Üí</button>
  </div>
</div>

<div class="container" id="mainApp" style="display:none">
  <header style="display:flex;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;gap:12px">
    <div>
      <h1>üí∏ Magnus Andersson</h1>
      <p>F√∂lj upp min inkomster, utgifter och investeringar</p>
    </div>
    <button class="logout-btn" onclick="doLogout()">Logga ut</button>
  </header>

  <!-- TABS -->
  <div class="tabs-wrap">
    <div class="tabs">
      <button class="tab active" onclick="switchTab('budget',this)">üí∞ Budget</button>
      <button class="tab" onclick="switchTab('invest',this)">üìà Investeringar</button>
    </div>
    <div class="invest-badge" id="investBadge" style="display:none">
      <div class="invest-badge-icon">üè¶</div>
      <div class="invest-badge-content">
        <div class="invest-badge-label">Investerat</div>
        <div class="invest-badge-value" id="investBadgeValue">0 kr</div>
      </div>
    </div>
  </div>

  <!-- ===================== BUDGET TAB ===================== -->
  <div class="tab-section active" id="tab-budget" style="display:block">

  <!-- SUMMARY CARDS -->
  <div class="cards">
    <div class="card income">
      <div class="card-icon">üìà</div>
      <div class="card-label">Tillg√§ngligt kapital</div>
      <div class="card-value" id="totIn">0 kr</div>
      <div class="card-sub" id="cntIn">0 poster</div>
    </div>
    <div class="card expense">
      <div class="card-icon">üìâ</div>
      <div class="card-label">Totala utgifter</div>
      <div class="card-value" id="totEx">0 kr</div>
      <div class="card-sub" id="cntEx">0 poster</div>
    </div>
    <div class="card balance">
      <div class="card-icon">‚öñÔ∏è</div>
      <div class="card-label">Saldo</div>
      <div class="card-value" id="bal">0 kr</div>
      <div class="card-sub" id="balNote">Inkomster minus utgifter</div>
    </div>
  </div>

  <!-- PROGRESS BAR -->
  <div class="prog-wrap">
    <div class="prog-header">
      <span>Utgifter som andel av inkomster</span>
      <span class="prog-pct" id="pct">0%</span>
    </div>
    <div class="prog-bg"><div class="prog-fill" id="bar" style="width:0%"></div></div>
  </div>

  <!-- INPUT FORMS -->
  <div class="columns">
    <div class="panel">
      <div class="panel-header"><span class="dot dot-g"></span>L√§gg till inkomst</div>
      <div class="form-body">
        <div class="form-row"><label>Beskrivning</label><input type="text" id="iDesc" placeholder="t.ex. M√•nadsl√∂n, Frilansuppdrag‚Ä¶"/></div>
        <div class="form-row"><label>Belopp (kr)</label><input type="number" id="iAmt" placeholder="0" min="0" step="1"/></div>
        <div class="form-row"><label>Kategori</label>
          <select id="iCat">
            <option>L√∂n</option>
            <option>√ñvrigt</option>
          </select>
        </div>
        <div class="form-row"><label>Datum</label><input type="date" id="iDate"/></div>
        <button class="btn btn-g" onclick="add('income')">Ôºã L√§gg till inkomst</button>
      </div>
    </div>
    <div class="panel">
      <div class="panel-header"><span class="dot dot-r"></span>L√§gg till utgift</div>
      <div class="form-body">
        <div class="form-row"><label>Beskrivning</label><input type="text" id="eDesc" placeholder="t.ex. Hyra, ICA, Spotify‚Ä¶"/></div>
        <div class="form-row"><label>Belopp (kr)</label><input type="number" id="eAmt" placeholder="0" min="0" step="1"/></div>
        <div class="form-row"><label>Kategori</label>
          <select id="eCat">
            <option>Boende</option><option>Mat & Dryck</option><option>Transport</option>
            <option>N√∂je & Fritid</option><option>H√§lsa & V√•rd</option><option>Kl√§der</option>
            <option>Teknik & Prenumerationer</option><option>Sparande</option><option>√ñvrigt</option><option>Snus</option>
          </select>
        </div>
        <div class="form-row"><label>Datum</label><input type="date" id="eDate"/></div>
        <button class="btn btn-r" onclick="add('expense')">Ôºã L√§gg till utgift</button>
      </div>
    </div>
  </div>

  <!-- CATEGORY BREAKDOWN -->
  <div class="breakdown">
    <div class="section-title">üìä Utgifter per kategori</div>
    <div id="catArea"><p style="color:var(--dim);font-size:.82rem">Inga utgifter registrerade √§nnu.</p></div>
  </div>

    <!-- YEARLY NET CHART -->
  <div class="panel" style="margin-top:16px">
    <div class="panel-header"><span class="dot dot-b"></span>Inkomst vs utgifter ‚Äì per m√•nad (√•r)</div>
    <div class="form-body" style="padding-top:10px">
      <div class="filter-bar" style="justify-content:space-between;gap:12px;flex-wrap:wrap">
        <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
          <label for="netYear" style="min-width:auto">√Ör:</label>
          <select id="netYear" class="sel" onchange="updateNetChart()"></select>
          <div class="tip muted">Visar (inkomster ‚àí utgifter) per m√•nad f√∂r valt √•r.</div>
        </div>
      </div>
      <canvas id="netChart" width="1100" height="260" style="width:100%;height:auto;border:1px solid var(--border);border-radius:12px;background:rgba(0,0,0,.10)"></canvas>
      <div class="muted" style="margin-top:8px">Gr√∂n stapel = √∂verskott, r√∂d stapel = underskott. Linjen visar nettot.
</div>
    </div>
 </div>
  <!-- SAVINGS & INCOME OVERVIEW -->
  <div class="savings-income-grid">
    <!-- SPARKONTO -->
    <div class="savings-card">
      <div class="sec-head">üè¶ Sparkonto</div>
      <div id="savingsStats">
        <div class="savings-stat"><span class="savings-stat-label">Aktuellt saldo</span><span class="savings-stat-val" id="savCurrentVal" style="color:var(--cyan)">‚Äì</span></div>
        <div class="savings-stat"><span class="savings-stat-label">F√∂r√§ndring (senaste)</span><span class="savings-stat-val" id="savLastChange">‚Äì</span></div>
        <div class="savings-stat"><span class="savings-stat-label">Senast uppdaterat</span><span class="savings-stat-val" id="savLastDate" style="font-size:.82rem;color:var(--dim)">‚Äì</span></div>
      </div>
      <div class="savings-form">
        <input type="number" id="savAmt" placeholder="Saldo (kr)" min="0" step="1"/>
        <input type="month" id="savMonth"/>
        <button class="btn btn-g" onclick="addSavings()" style="font-size:.82rem;padding:10px 14px">Ôºã Spara</button>
      </div>
      <canvas id="savingsChart" height="90" style="width:100%;margin-top:14px;border-radius:8px;background:rgba(0,0,0,.1)"></canvas>
    </div>

    <!-- INKOMSTER SAMMANFATTNING -->
    <div class="savings-card">
      <div class="sec-head">üí∞ Inkomster ‚Äì √∂versikt</div>
      <div id="incomeStats">
        <div class="savings-stat"><span class="savings-stat-label">Total (alla tider)</span><span class="savings-stat-val" id="incTotalAll" style="color:var(--green)">‚Äì</span></div>
        <div class="savings-stat"><span class="savings-stat-label">Innevarande m√•nad</span><span class="savings-stat-val" id="incThisMonth" style="color:var(--green)">‚Äì</span></div>
        <div class="savings-stat"><span class="savings-stat-label">Snitt per m√•nad</span><span class="savings-stat-val" id="incAvgMonth" style="color:var(--muted)">‚Äì</span></div>
        <div class="savings-stat"><span class="savings-stat-label">B√§sta m√•nad</span><span class="savings-stat-val" id="incBestMonth" style="color:var(--accent);font-size:.88rem">‚Äì</span></div>
      </div>
      <canvas id="incomeBarChart" height="90" style="width:100%;margin-top:14px;border-radius:8px;background:rgba(0,0,0,.1)"></canvas>
    </div>
  </div>

<!-- TRANSACTIONS TABLE -->
  <div class="panel" style="margin-top:18px">
    <div class="panel-header"><span class="dot dot-b"></span>Alla transaktioner</div>
    <div class="form-body" style="padding-bottom:0">
      <div class="filter-bar">
        <label>Filtrera p√• m√•nad:</label>
        <input type="month" id="mFilter" oninput="render()"/>
        <button class="clr-btn" onclick="clearFilter()">‚úï Visa alla</button>
      </div>
    </div>
    <div class="table-wrap">
      <table>
        <thead><tr>
          <th>Beskrivning</th><th>Kategori</th><th>Datum</th><th>Typ</th><th style="text-align:right">Belopp</th><th></th>
        </tr></thead>
        <tbody id="tBody"></tbody>
      </table>
      <div id="emptyMsg" class="empty" style="display:none">
        <div class="empty-icon">üì≠</div>
        Inga transaktioner att visa f√∂r vald period.
      </div>
    </div>
  </div>

</div><!-- /tab-budget -->

  <!-- ===================== INVEST TAB ===================== -->
  <div class="tab-section" id="tab-invest" style="display:none">

    <!-- INVEST SUMMARY CARDS -->
    <div class="inv-cards">
      <div class="card inv-val">
        <div class="card-icon">üíº</div>
        <div class="card-label" style="color:var(--blue)">Dagens v√§rde</div>
        <div class="card-value" id="invTotVal" style="color:var(--text)">0 kr</div>
        <div class="card-sub" id="invValNote">‚Äì</div>
      </div>
      <div class="card inv-gain" id="invGainCard">
        <div class="card-icon">üìä</div>
        <div class="card-label" style="color:var(--green)">Utveckling (kr)</div>
        <div class="card-value" id="invTotGainKr">0 kr</div>
        <div class="card-sub" id="invGainNote">‚Äì</div>
      </div>
      <div class="card inv-gain" id="invPctCard">
        <div class="card-icon">üéØ</div>
        <div class="card-label" style="color:var(--green)">Utveckling (%)</div>
        <div class="card-value" id="invTotGainPct">0%</div>
        <div class="card-sub">Totalt avkastning</div>
      </div>
    </div>

    <!-- ADD INVESTMENT FORM -->
    <div class="columns" style="grid-template-columns:1fr">
      <div class="panel">
        <div class="panel-header"><span class="dot dot-g"></span>L√§gg till investering</div>
        <div class="form-body">
          <div class="form-row">
            <label>Aktie / Fond</label>
            <select id="invName">
              <option value="">V√§lj aktie...</option>
              <option>Investor</option>
              <option>Axfood</option>
              <option>AMF Europa</option>
              <option>Handelsbanken</option>
              <option>Industriv√§rden C</option>
              <option>SEB Sparkonto</option>
            </select>
          </div>
<div class="form-row">
            <label>Investerat belopp (kr)</label>
            <input type="number" id="invCost" placeholder="0" min="0" step="any"/>
          </div>
          <div class="form-row">
            <label>Dagens v√§rde (kr)</label>
            <input type="number" id="invVal" placeholder="0" min="0" step="any"/>
          </div>
          <div class="form-row">
            <label>K√∂pdatum</label>
            <input type="date" id="invDate"/>
          </div>
          <button class="btn btn-g" onclick="addInv()">Ôºã L√§gg till</button>
        </div>
      </div>


    <!-- PORTFOLIO TABLE -->
    <div class="panel">
      <div class="panel-header"><span class="dot dot-b"></span>Min portf√∂lj</div>
      <div class="inv-table-wrap">
        <table class="inv-table">
          <thead><tr>
            <th>Namn</th>
            <th class="num">Investerat</th>
<th class="num">Utveckling</th>
            <th></th>
          </tr></thead>
          <tbody id="invBody"></tbody>
        </table>
        <div id="invEmpty" class="empty" style="display:none">
          <div class="empty-icon">üì≠</div>
          Inga investeringar registrerade √§nnu.
        </div>
      </div>
    </div>

    <!-- PER-STOCK CHARTS -->
    <div class="chart-wrap" style="margin-top:16px;" id="stockChartsSection">
      <div class="chart-header" style="margin-bottom:12px">
        <div class="chart-title">üìä Utveckling per aktie</div>
      </div>
      <div class="stock-tabs" id="stockTabs"></div>
      <div id="stockChartPanels"></div>
    </div>

    <!-- CHART PANEL -->
    <div class="chart-wrap" style="margin-top:16px;">
      <div class="chart-header">
        <div class="chart-title">üìà Portf√∂ljutveckling per m√•nad</div>
        <div style="display:flex;align-items:center;gap:20px;flex-wrap:wrap">
          <div class="chart-legend">
            <div class="legend-item"><div class="legend-dot" style="background:#7c3aed"></div>Investerat</div>
            <div class="legend-item"><div class="legend-dot" style="background:#22c55e"></div>Portf√∂ljv√§rde</div>
            <div class="legend-item"><div class="legend-dot" style="background:#ff7a00;border-radius:2px"></div>M√•l: 1 000 000 kr</div>
          </div>
          <div class="chart-year">
            <button class="chart-year-btn" onclick="changeChartYear(-1)">‚Äπ</button>
            <span class="chart-year-label" id="chartYearLabel">2025</span>
            <button class="chart-year-btn" onclick="changeChartYear(1)">‚Ä∫</button>
          </div>
        </div>
      </div>
      <div class="chart-svg-wrap">
        <svg id="chartSvg" width="100%" height="260" style="display:block"></svg>
      </div>
      <div class="month-input-wrap">
        <div style="font-size:.78rem;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.7px;margin-bottom:12px">Ange totalt portf√∂ljv√§rde (kr) per m√•nad ‚Äî eller fyll i automatiskt via k√∂phistoriken ovan</div>
        <div class="month-grid" id="monthInputGrid"></div>
      </div>
    </div>

    </div>

  </div><!-- /tab-invest -->

<!-- CHART TOOLTIP -->
<div class="chart-tooltip" id="chartTooltip">
  <div class="tt-month" id="ttMonth"></div>
  <div class="tt-row"><span class="tt-label">Investerat</span><span class="tt-val" id="ttCost" style="color:#7c3aed"></span></div>
  <div class="tt-row"><span class="tt-label">V√§rde</span><span class="tt-val" id="ttVal" style="color:#22c55e"></span></div>
  <div class="tt-row"><span class="tt-label">Utveckling</span><span class="tt-val" id="ttGain"></span></div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

</div>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

// =================== SUPABASE ===================
const SUPABASE_URL = "https://ivkpxyylajewvbvwebvu.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_15LBNxbc-LWTHqLG3QTZhQ_nWmBG3HK";
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
// Expose for debugging
window.supabase = supabase;

// 1 anv√§ndare (ANV√ÑNDARNAMN i UI, email bakom kulisserna)
const LOGIN_EMAIL = "magnusrcandersson@icloud.com";
const DISPLAY_USERNAME = "massemus";

// =================== GLOBALS ===================
const MONTHS = ['Jan','Feb','Mar','Apr','Maj','Jun','Jul','Aug','Sep','Okt','Nov','Dec'];
let chartYear = new Date().getFullYear();
let chartData = {};
// Supabase-persistens (debounced)
let _chartSaveT = null;
async function saveChartData() {
  clearTimeout(_chartSaveT);
  _chartSaveT = setTimeout(async () => {
    try {
      const { data: u } = await supabase.auth.getUser();
      const user_id = u.user?.id;
      if (!user_id) return;
      const yk = String(chartYear);
      // Bygg rader f√∂r √•ret
      const rows = [];
      const arr = chartData[yk] || [];
      for (let i=0;i<12;i++) {
        const v = arr[i]?.val;
        if (v === '' || v === null || v === undefined || Number.isNaN(Number(v))) continue;
        rows.push({ user_id, year: Number(yk), month: i+1, val: Number(v) });
      }
      // Ers√§tt √•rets rader
      await supabase.from('portfolio_month_values').delete().eq('user_id', user_id).eq('year', Number(yk));
      if (rows.length) await supabase.from('portfolio_month_values').insert(rows);
    } catch(e) { console.warn(e); }
  }, 250);
}


const CC={
  'L√∂n': '#7c3aed',
  'Frilans': '#a78bfa',
  'Investering': '#22d3ee',
  'Bidrag / Ers√§ttning': '#ff7a00',
  'R√§nta / Utdelning': '#22c55e',
  'Boende': '#ef4444',
  'Mat & Dryck': '#ff9a3d',
  'Transport': '#fbbf24',
  'N√∂je & Fritid': '#ec4899',
  'H√§lsa & V√•rd': '#22c55e',
  'Kl√§der': '#a78bfa',
  'Teknik & Prenumerationer': '#22d3ee',
  'Sparande': '#14b8a6',
  '√ñvrigt': '#94a3b8'
};
const SCOLORS = {
  'Teknik':'#7c3aed','Finans':'#06b6d4','H√§lsa':'#22c55e','Industri':'#ff9a3d',
  'Konsument':'#ec4899','Energi':'#eab308','Fastigheter':'#ef4444',
  'Fond / ETF':'#a78bfa','Krypto':'#ff7a00','√ñvrigt':'#94a3b8'
};

let data = [];
let invData = [];
const now   = () => new Date().toISOString().slice(0, 10);
const fmt   = n => (n||0).toLocaleString('sv-SE', {minimumFractionDigits:0}) + ' kr';
const esc   = s => String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
const fmtD  = d => { if(!d) return '‚Äì'; const [y,m,day]=d.split('-'); return `${day}/${m}/${y}`; };
let _saveT = null;

async function persistTransactions() {
  const { data: u } = await supabase.auth.getUser();
  const user_id = u.user?.id;
  if (!user_id) return;

  // Ers√§tt alla transaktioner f√∂r anv√§ndaren (enkel men robust)
  const { error: dErr } = await supabase.from('transactions').delete().eq('user_id', user_id);
  if (dErr) throw dErr;

  if (data.length) {
    const rows = data.map(t => ({
      id: String(t.id),
      user_id,
      type: t.type,
      cat: t.cat,
      desc: t.desc,
      amt: Number(t.amt),
      date: t.date
    }));
    const { error: iErr } = await supabase.from('transactions').insert(rows);
    if (iErr) throw iErr;
  }
}

// Debounced autosave (anv√§nds i bakgrunden)
const save = () => {
  clearTimeout(_saveT);
  _saveT = setTimeout(async () => {
    try { await persistTransactions(); }
    catch(e){ console.warn(e); }
  }, 200);
};

// Spara NU och v√§nta tills det √§r klart (anv√§nds efter add/edit/delete)
async function flushSave() {
  clearTimeout(_saveT);
  await persistTransactions();
}

let _saveInvT = null;

async function persistInvestments() {
  const { data: u } = await supabase.auth.getUser();
  const user_id = u.user?.id;
  if (!user_id) return;

  const { error: dErr } = await supabase.from('invest_purchases').delete().eq('user_id', user_id);
  if (dErr) throw dErr;

  if (invData.length) {
    const rows = invData.map(p => ({
      id: String(p.id),
      user_id,
      name: p.name,
      cost: Number(p.cost),
      val: Number(p.val),
      date: p.date
    }));
    const { error: iErr } = await supabase.from('invest_purchases').insert(rows);
    if (iErr) throw iErr;
  }
}

const saveInv = () => {
  clearTimeout(_saveInvT);
  _saveInvT = setTimeout(async () => {
    try { await persistInvestments(); }
    catch(e){ console.warn(e); }
  }, 200);
};

async function flushSaveInv() {
  clearTimeout(_saveInvT);
  await persistInvestments();
}

const fmtNum  = n => (n||0).toLocaleString('sv-SE', {minimumFractionDigits:0, maximumFractionDigits:4});
// =================== TOAST ===================
function showToast(msg, type='green') {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = `toast ${type} show`;
  setTimeout(() => t.className = `toast ${type}`, 2800);
}

// =================== LOGIN ===================
// =================== AUTH (Supabase) ===================
async function checkSession() {
  const { data } = await supabase.auth.getSession();
  return !!data.session;
}

async function loadAllFromSupabase() {
  const { data: u } = await supabase.auth.getUser();
  const user_id = u.user?.id;
  if (!user_id) return;

  // Transactions
  const { data: tx, error: e1 } = await supabase
    .from('transactions')
    .select('id,type,cat,desc,amt,date')
    .order('date', { ascending: false });
  if (e1) throw e1;
  data = (tx || []).map(t => ({
    id: t.id,
    type: t.type,
    cat: t.cat,
    desc: t.desc,
    amt: Number(t.amt),
    date: String(t.date)
  }));

  // Investments
  const { data: inv, error: e2 } = await supabase
    .from('invest_purchases')
    .select('id,name,cost,val,date')
    .order('date', { ascending: true });
  if (e2) throw e2;
  invData = (inv || []).map(p => ({
    id: p.id,
    name: p.name,
    cost: Number(p.cost),
    val: Number(p.val),
    date: String(p.date)
  }));

  // Chart month values
  const { data: mv, error: e3 } = await supabase
    .from('portfolio_month_values')
    .select('year,month,val');
  if (e3) throw e3;
  chartData = {};
  (mv || []).forEach(r => {
    const yk = String(r.year);
    if (!chartData[yk]) chartData[yk] = Array(12).fill(null).map(() => ({ val: '' }));
    chartData[yk][r.month - 1].val = Number(r.val);
  });
}

async function doLogin() {
  const user = document.getElementById('loginUser').value.trim();
  const pass = document.getElementById('loginPass').value;
  const err  = document.getElementById('loginErr');

  if (user.toLowerCase() !== DISPLAY_USERNAME.toLowerCase()) {
    err.style.display = 'block';
    err.textContent = 'Fel anv√§ndarnamn';
    document.getElementById('loginPass').value = '';
    return;
  }

  const { error } = await supabase.auth.signInWithPassword({ email: LOGIN_EMAIL, password: pass });
  if (error) {
    err.style.display = 'block';
    err.textContent = error.message;
    document.getElementById('loginPass').value = '';
    return;
  }

  err.style.display = 'none';
  document.getElementById('loginScreen').style.display = 'none';
  document.getElementById('mainApp').style.display = 'block';

  try { await loadAllFromSupabase(); await loadSavings(); } catch(e){ console.warn(e); }
  render();
      updateNetChart();
      renderInv(); initChart();
  renderSavings();
  renderIncomeOverview();
  drawStockCharts();
  document.getElementById('savMonth').value = new Date().toISOString().slice(0,7);
}

async function doLogout() {
  await supabase.auth.signOut();
  document.getElementById('loginScreen').style.display = 'flex';
  document.getElementById('mainApp').style.display = 'none';
  document.getElementById('loginUser').value = '';
  document.getElementById('loginPass').value = '';
}

// =================== TAB SWITCHING ===================
function switchTab(name, btn) {
  // Allow calling switchTab('budget') without passing the button
  if (!btn) {
    const btns = Array.from(document.querySelectorAll('.tab'));
    btn = btns.find(b => (b.getAttribute('onclick') || '').includes(`'${name}'`)) || btns[0];
  }

  document.querySelectorAll('.tab-section').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(b => b.classList.remove('active'));

  const section = document.getElementById('tab-' + name);
  if (section) section.classList.add('active');
  if (btn) btn.classList.add('active');

  const badge = document.getElementById('investBadge');
  if (badge) badge.style.display = (name === 'invest') ? 'flex' : 'none';

  // Hard-hide invest-only panels if we are in budget (extra safety)
  if (name !== 'invest') {
    document.querySelectorAll('#tab-invest .card, #tab-invest .panel').forEach(() => {}); // no-op, relies on tab-section display
  } else {
    setTimeout(drawChart, 50);
  }

  // Explicit display toggles (robust even if CSS is overridden)
  const b = document.getElementById('tab-budget');
  const i = document.getElementById('tab-invest');
  if (b) b.style.display = (name === 'budget') ? 'block' : 'none';
  if (i) i.style.display = (name === 'invest') ? 'block' : 'none';

}

// =================== BUDGET ===================
document.getElementById('iDate').value = now();
document.getElementById('eDate').value = now();

async function add(type) {
  const p = type === 'income' ? 'i' : 'e';
  const descEl = document.getElementById(p+'Desc');
  const amtEl  = document.getElementById(p+'Amt');
  const dateEl = document.getElementById(p+'Date');
  const desc   = descEl.value.trim();
  const amt    = parseFloat(amtEl.value);
  const cat    = document.getElementById(p+'Cat').value;
  const date   = dateEl.value;
  let ok = true;
  if (!desc)          { descEl.classList.add('error'); setTimeout(()=>descEl.classList.remove('error'),400); ok=false; }
  if (!amt || amt<=0) { amtEl.classList.add('error');  setTimeout(()=>amtEl.classList.remove('error'),400);  ok=false; }
  if (!date)          { dateEl.classList.add('error'); setTimeout(()=>dateEl.classList.remove('error'),400); ok=false; }
  if (!ok) return;

  // Optimistisk UI
  data.unshift({ id: crypto.randomUUID(), type, desc, amt, cat, date });
  render();

  // Spara och ladda om f√∂r att garantera att UI matchar databasen direkt
  try {
    await flushSave();
    await loadAllFromSupabase();
    render();
    updateNetChart();
  } catch(e) {
    console.warn(e);
    showToast('Kunde inte spara (kontrollera anslutning)', 'red');
  }

  descEl.value = ''; amtEl.value = '';
  dateEl.value = now();
  showToast(type==='income' ? '‚úì Inkomst tillagd' : '‚úì Utgift tillagd', type==='income'?'green':'red');
}

async function del(id) {
  data = data.filter(t => String(t.id) !== String(id));
  render();
  try {
    await flushSave();
    await loadAllFromSupabase();
    render();
    updateNetChart();
  } catch(e) {
    console.warn(e);
    showToast('Kunde inte ta bort (kontrollera anslutning)', 'red');
    return;
  }
  showToast('Transaktion borttagen', 'red');
}

async function editTx(id) {
  const t = data.find(x => String(x.id) === String(id));
  if (!t) return;

  const typeLabel = t.type === 'income' ? 'inkomst' : 'utgift';

  const desc = prompt('Redigera beskrivning (' + typeLabel + '):', t.desc);
  if (desc === null) return;

  const amtRaw = prompt('Redigera belopp (kr):', String(t.amt));
  if (amtRaw === null) return;
  const amt = parseFloat(String(amtRaw).replace(',', '.'));
  if (isNaN(amt) || amt <= 0) { showToast('Ogiltigt belopp', 'red'); return; }

  const cat = prompt('Redigera kategori:', t.cat);
  if (cat === null) return;

  const date = prompt('Redigera datum (YYYY-MM-DD):', t.date);
  if (date === null) return;
  if (!/^\d{4}-\d{2}-\d{2}$/.test(date)) { showToast('Ogiltigt datumformat', 'red'); return; }

  // Optimistisk UI
  t.desc = desc.trim();
  t.amt  = amt;
  t.cat  = cat.trim();
  t.date = date;
  render();
  updateNetChart();

  try {
    await flushSave();
    await loadAllFromSupabase();
    render();
    updateNetChart();
  } catch(e) {
    console.warn(e);
    showToast('Kunde inte spara (kontrollera anslutning)', 'red');
    return;
  }

  showToast('Transaktion uppdaterad', 'green');
}

function clearFilter() {
  document.getElementById('mFilter').value = '';
  render();
  updateNetChart();
}

function render() {
  const m   = document.getElementById('mFilter').value;
  const vis = m ? data.filter(t => t.date.startsWith(m)) : data;
  const inc = vis.filter(t => t.type === 'income');
  const exp = vis.filter(t => t.type === 'expense');
  const tI  = inc.reduce((s,t) => s+t.amt, 0);
  const tE  = exp.reduce((s,t) => s+t.amt, 0);
  const b   = tI - tE;
  const p   = tI > 0 ? Math.min(tE/tI*100, 100) : (tE > 0 ? 100 : 0);

  document.getElementById('totIn').textContent = fmt(tI);
  document.getElementById('totEx').textContent = fmt(tE);
  document.getElementById('cntIn').textContent = inc.length + (inc.length===1?' post':' poster');
  document.getElementById('cntEx').textContent = exp.length + (exp.length===1?' post':' poster');

  const bEl = document.getElementById('bal');
  bEl.textContent = (b < 0 ? '‚àí' : '') + fmt(Math.abs(b));
  bEl.className = 'card-value' + (b < 0 ? ' neg' : '');
  document.getElementById('balNote').textContent = b >= 0 ? '‚úì Positivt saldo' : '‚ö† Underskott';

  const bar = document.getElementById('bar');
  bar.style.width = p + '%';
  bar.className = 'prog-fill' + (p > 85 ? ' danger' : p > 65 ? ' warn' : '');
  document.getElementById('pct').textContent = Math.round(p) + '%';

  const tb = document.getElementById('tBody');
  const em = document.getElementById('emptyMsg');
  if (!vis.length) {
    tb.innerHTML = ''; em.style.display = 'block';
  } else {
    em.style.display = 'none';
    tb.innerHTML = [...vis]
      .sort((a,b) => b.date.localeCompare(a.date) || String(b.id).localeCompare(String(a.id)))
      .map(t => `<tr>
        <td>${esc(t.desc)}</td>
        <td><span class="badge badge-${t.type}">${esc(t.cat)}</span></td>
        <td style="white-space:nowrap">${fmtD(t.date)}</td>
        <td style="color:var(--dim);font-size:.8rem">${t.type==='income'?'Inkomst':'Utgift'}</td>
        <td class="amt-${t.type[0]}" style="text-align:right;white-space:nowrap">${t.type==='income'?'+':'‚àí'}${fmt(t.amt)}</td>
        <td style="white-space:nowrap;text-align:right">
          <button class="edit" onclick="editTx(\'${t.id}\')" title="Redigera">‚úé</button>
          <button class="del" onclick="del(\'${t.id}\')" title="Ta bort">‚úï</button>
        </td>
      </tr>`).join('');
  }

  const cm = {};
  exp.forEach(t => { cm[t.cat] = (cm[t.cat]||0) + t.amt; });
  const cats = Object.entries(cm).sort((a,b) => b[1]-a[1]);
  const mx = cats[0]?.[1] || 1;
  document.getElementById('catArea').innerHTML = cats.length
    ? cats.map(([c,a]) => `<div class="cat-row">
        <div class="cat-name" title="${esc(c)}">${esc(c)}</div>
        <div class="cat-bg"><div class="cat-fill" style="width:${(a/mx*100).toFixed(1)}%;background:${CC[c]||'#94a3b8'}"></div></div>
        <div class="cat-amt" style="color:${CC[c]||'#94a3b8'}">${fmt(a)}</div>
      </div>`).join('')
    : '<p style="color:var(--dim);font-size:.82rem">Inga utgifter att visa f√∂r vald period.</p>';
  renderIncomeOverview();
}

// =================== INVESTMENTS ===================
document.getElementById('invDate').value = now();

function getHoldings() {
  const map = {};
  invData.forEach(p => {
    const key = p.name.toLowerCase();
    if (!map[key]) map[key] = { name:p.name, cost:0, val:0 };    map[key].cost   += p.cost;
    map[key].val    += p.val;
  });
  return Object.values(map);
}

async function addInv() {
  const nameEl   = document.getElementById('invName');  const costEl   = document.getElementById('invCost');
  const valEl    = document.getElementById('invVal');
  const dateEl   = document.getElementById('invDate');
  const name     = nameEl.value.trim();  const cost     = parseFloat(costEl.value);
  const val      = parseFloat(valEl.value);
  const date     = dateEl.value;
  let ok = true;
  if (!name)               { nameEl.classList.add('error');  setTimeout(()=>nameEl.classList.remove('error'),400);  ok=false; }
  if (isNaN(cost)||cost<0) { costEl.classList.add('error');  setTimeout(()=>costEl.classList.remove('error'),400);  ok=false; }
  if (isNaN(val)||val<0)   { valEl.classList.add('error');   setTimeout(()=>valEl.classList.remove('error'),400);   ok=false; }
  if (!date)               { dateEl.classList.add('error');  setTimeout(()=>dateEl.classList.remove('error'),400);  ok=false; }
  if (!ok) return;
  invData.push({ id:crypto.randomUUID(), name, cost, val, date });

  // Tolka inmatat "Dagens v√§rde" som TOTALT v√§rde f√∂r innehavet (inte per k√∂p).
  // Om det finns flera k√∂p p√• samma namn f√∂rdelas totalv√§rdet proportionellt efter investerat belopp.
  const nameLower = String(name).toLowerCase();
  const purchases = invData.filter(p => String(p.name).toLowerCase() === nameLower);
  if (purchases.length > 1) {
    const totalCost = purchases.reduce((sum, p) => sum + (p.cost || 0), 0);
    purchases.forEach(p => {
      if (totalCost > 0) p.val = (p.cost / totalCost) * val;
      else p.val = val / purchases.length;
    });
  }

  showToast('‚úì K√∂p registrerat', 'green');
  renderInv();
  try {
    await flushSaveInv();
    await loadAllFromSupabase();
    renderInv();
    drawChart();
  } catch(e) {
    console.warn(e);
    showToast('Kunde inte spara investering (kontrollera anslutning)', 'red');
  }

  nameEl.value='';
  costEl.value='';
  valEl.value='';
  dateEl.value = now();
}

async function delInv(id) {
  invData = invData.filter(i => String(i.id) !== String(id));
  renderInv();
  try {
    await flushSaveInv();
    await loadAllFromSupabase();
    renderInv();
    drawChart();
  } catch(e) {
    console.warn(e);
    showToast('Kunde inte ta bort investering (kontrollera anslutning)', 'red');
    return;
  }
  showToast('Investering borttagen', 'red');
}

function delHolding(name) {
  const nameLower = name.toLowerCase();
  invData = invData.filter(i => i.name.toLowerCase() !== nameLower);
  saveInv(); renderInv();
  showToast('Alla k√∂p av ' + name + ' borttagna', 'red');
}

function delHoldingBtn(btn) {
  delHolding(btn.dataset.name);
}

function toggleEdit(name) {
  const raw = prompt('Ange nytt dagsv√§rde (kr) f√∂r ' + name + ':');
  if (raw === null) return;
  const val = parseFloat(String(raw).replace(',', '.'));
  if (isNaN(val) || val < 0) { showToast('Ogiltigt v√§rde', 'red'); return; }

  const nameLower = String(name).toLowerCase();
  const purchases = invData.filter(p => String(p.name).toLowerCase() === nameLower);
  if (!purchases.length) return;

  const totalCost = purchases.reduce((sum, p) => sum + (p.cost || 0), 0);
  purchases.forEach(p => {
    if (totalCost > 0) p.val = (p.cost / totalCost) * val;
    else p.val = val / purchases.length;
  });

  saveInv(); renderInv();
  showToast(name + ' uppdaterat', 'green');
}


function drawChart() {
  const svg = document.getElementById('chartSvg');
  if (!svg) return;
  const W = Math.max(svg.getBoundingClientRect().width || 700, 480);
  const H = 260;
  const PAD = { top: 24, right: 20, bottom: 42, left: 72 };
  const cW = W - PAD.left - PAD.right;
  const cH = H - PAD.top - PAD.bottom;
  const months  = getMonthData(chartYear);
  const holdings = getHoldings();
  const totVal  = holdings.reduce((s,h) => s + h.val, 0);   // live portfolio value

  const totalCost = invData.reduce((s,i) => s + i.cost, 0);  // total invested

  const pts = months.map((m, idx) => {
    const ym    = `${chartYear}-${String(idx+1).padStart(2,'0')}`;
    const nowYM = new Date().toISOString().slice(0,7);

    // Green line = portfolio market value
    // 1) Manuell inmatning per m√•nad har alltid f√∂retr√§de
    // 2) Om ingen manuell: auto = summerat v√§rde av alla investeringar t.o.m. m√•naden
    // 3) F√∂r innevarande m√•nad: LIVE totVal (om >0) om inte manuell finns
    let val = null;
    const autoPV = getAutoPortVal(chartYear, idx);

    if (m.val !== '') {
      val = parseFloat(m.val);
    } else if (ym === nowYM && totVal > 0) {
      val = totVal;
    } else if (autoPV !== null) {
      val = autoPV;
    }


    // Blue dashed line = cumulative invested amount up to this month
    const cumInvested = invData
      .filter(p => p.date && p.date.slice(0,7) <= ym)
      .reduce((s,p) => s + p.cost, 0) || totalCost;

    return { i: idx, val, cost: cumInvested, invested: totalCost };
  });

  const GOAL    = 1000000;
  const valPts  = pts.filter(p => p.val !== null);
  const maxCost = Math.max(...pts.map(p => p.cost), 0);
  const allNums = [0, maxCost, GOAL, ...valPts.map(p => p.val)];
  const maxV = Math.max(...allNums) * 1.08 || 1000;
  const minV = Math.min(0, ...allNums);
  const range = maxV - minV || 1;
  const xP = i => PAD.left + (i / 11) * cW;
  const yP = v => PAD.top + cH - ((v - minV) / range) * cH;

  let g = '';
  [0, 0.25, 0.5, 0.75, 1].forEach(t => {
    const v   = minV + range * t;
    const y   = yP(v);
    const lbl = v >= 1e6 ? (v/1e6).toFixed(1)+'M' : v >= 1e3 ? Math.round(v/1e3)+'k' : Math.round(v)+'';
    g += `<line x1="${PAD.left}" y1="${y}" x2="${W-PAD.right}" y2="${y}" stroke="#2e3347" stroke-width="1" stroke-dasharray="4,3"/>`;
    g += `<text x="${PAD.left-8}" y="${y+4}" text-anchor="end" fill="#64748b" font-size="11" font-family="Inter,Arial">${lbl}</text>`;
  });

  // Cost line: step through each month's cumulative invested amount
  const costLinePts = pts.map(p => `${xP(p.i)},${yP(p.cost)}`).join(' L ');
  const costLine = `<path d="M ${costLinePts}" stroke="#7c3aed" stroke-width="2" stroke-dasharray="7,4" fill="none" opacity="0.8"/>`;

  // Goal line at 1 000 000 kr
  const goalY    = yP(GOAL);
  const goalPct  = totVal > 0 ? Math.min(totVal / GOAL * 100, 100) : 0;
  const goalDone = totVal >= GOAL;
  const goalCol  = goalDone ? '#22c55e' : '#ff7a00';
  const goalLine = `
    <line x1="${PAD.left}" y1="${goalY}" x2="${W - PAD.right}" y2="${goalY}"
      stroke="${goalCol}" stroke-width="1.5" stroke-dasharray="10,5" opacity="0.9"/>
    <rect x="${W - PAD.right - 98}" y="${goalY - 11}" width="96" height="20" rx="6"
      fill="${goalCol}" opacity="0.15"/>
    <text x="${W - PAD.right - 50}" y="${goalY + 5}" text-anchor="middle"
      fill="${goalCol}" font-size="11" font-weight="600" font-family="Inter,Arial">
      üéØ ${goalDone ? '‚úì M√•l n√•tt!' : goalPct.toFixed(1) + '% av 1M'}
    </text>`;

  let area = '', line = '';
  if (valPts.length >= 2) {
    const coords = valPts.map(p => `${xP(p.i)},${yP(p.val)}`).join(' L ');
    area = `<path d="M ${xP(valPts[0].i)},${yP(minV)} L ${coords} L ${xP(valPts[valPts.length-1].i)},${yP(minV)} Z" fill="url(#vg)"/>`;
    line = `<path d="M ${coords}" stroke="#22c55e" stroke-width="2.5" fill="none" stroke-linejoin="round" stroke-linecap="round"/>`;
  } else if (valPts.length === 1) {
    line = `<circle cx="${xP(valPts[0].i)}" cy="${yP(valPts[0].val)}" r="4" fill="#22c55e"/>`;
  }

  // Vertical glow bars instead of dots ‚Äî one per data point
  const barW = Math.max(cW / 14, 8);
  const dots = valPts.map(p => {
    const pos = (p.val - p.invested) >= 0;
    const col = pos ? '#22c55e' : '#ef4444';
    const barTop = yP(p.val);
    const barH   = Math.max((PAD.top + cH) - barTop, 2);
    const gradId = `bg${p.i}`;
    return `
      <defs>
        <linearGradient id="${gradId}" x1="0" y1="0" x2="0" y2="1">
          <stop offset="0%" stop-color="${col}" stop-opacity="0.55"/>
          <stop offset="100%" stop-color="${col}" stop-opacity="0.03"/>
        </linearGradient>
      </defs>
      <rect x="${xP(p.i) - barW/2}" y="${barTop}" width="${barW}" height="${barH}"
        rx="4" fill="url(#${gradId})"
        style="cursor:pointer;transition:opacity .15s"
        onmouseenter="this.style.opacity='.75';showTT(event,${p.i},${p.val},${p.invested})"
        onmouseleave="this.style.opacity='1';hideTT()"/>
      <circle cx="${xP(p.i)}" cy="${barTop}" r="3.5"
        fill="${col}" stroke="#1a1d27" stroke-width="2" pointer-events="none"/>`;
  }).join('');

  const hits = pts.map(p => p.val !== null ? '' : '').join('');

  const xlbls = MONTHS.map((m,i) =>
    `<text x="${xP(i)}" y="${H-6}" text-anchor="middle" fill="#64748b" font-size="11" font-family="Inter,Arial">${m}</text>`
  ).join('');

  const empty = valPts.length === 0
    ? `<text x="${W/2}" y="${H/2}" text-anchor="middle" fill="#475569" font-size="13" font-family="Inter,Arial">Ange v√§rden nedan eller l√§gg till k√∂p med datum</text>`
    : '';

  svg.setAttribute('height', H);
  svg.innerHTML = `
    <defs>
      <linearGradient id="vg" x1="0" y1="0" x2="0" y2="1">
        <stop offset="0%" stop-color="#22c55e" stop-opacity="0.12"/>
        <stop offset="100%" stop-color="#22c55e" stop-opacity="0.01"/>
      </linearGradient>
    </defs>
    ${g}${goalLine}${costLine}${area}${line}${dots}${xlbls}${empty}`;
}

// ===================== BUDGET NET CHART (Income - Expense) =====================
let _netChartCache = { year: null, dataHash: null };

function getAvailableYearsFromTransactions() {
  const years = new Set();
  (data || []).forEach(t => {
    const y = String(t.date || "").slice(0,4);
    if (/^\d{4}$/.test(y)) years.add(Number(y));
  });
  const arr = Array.from(years).sort((a,b)=>a-b);
  if (arr.length === 0) arr.push(new Date().getFullYear());
  return arr;
}

function ensureNetYearOptions() {
  const sel = document.getElementById("netYear");
  if (!sel) return;
  const years = getAvailableYearsFromTransactions();
  const current = sel.value ? Number(sel.value) : null;

  // rebuild options
  sel.innerHTML = years.map(y => `<option value="${y}">${y}</option>`).join("");

  const preferred = current && years.includes(current) ? current : Math.max(...years);
  sel.value = String(preferred);
}

function computeMonthlyNet(year) {
  const net = Array(12).fill(0);
  (data || []).forEach(t => {
    const d = String(t.date || "");
    if (d.slice(0,4) !== String(year)) return;
    const m = Number(d.slice(5,7));
    if (!(m>=1 && m<=12)) return;
    const amt = Number(t.amt || 0);
    if (t.type === "income") net[m-1] += amt;
    else if (t.type === "expense") net[m-1] -= amt;
  });
  return net;
}

function drawNetChart(canvas, monthlyNet) {
  const ctx = canvas.getContext("2d");
  const w = canvas.width, h = canvas.height;
  ctx.clearRect(0,0,w,h);

  const padL = 46, padR = 16, padT = 14, padB = 34;
  const plotW = w - padL - padR;
  const plotH = h - padT - padB;

  const maxAbs = Math.max(1, ...monthlyNet.map(v => Math.abs(v)));
  const yMax = maxAbs * 1.15;
  const yMin = -yMax;

  function yScale(v){
    const t = (v - yMin) / (yMax - yMin);
    return padT + (1 - t) * plotH;
  }

  // grid + zero line
  ctx.globalAlpha = 0.35;
  ctx.strokeStyle = "#6b7280";
  ctx.lineWidth = 1;

  const steps = 4;
  for (let i=0;i<=steps;i++){
    const yVal = yMin + (i/steps)*(yMax - yMin);
    const y = yScale(yVal);
    ctx.beginPath();
    ctx.moveTo(padL, y);
    ctx.lineTo(padL + plotW, y);
    ctx.stroke();

    ctx.globalAlpha = 0.6;
    ctx.fillStyle = "#cbd5e1";
    ctx.font = "12px system-ui, -apple-system, Segoe UI, Roboto, Arial";
    const label = Math.round(yVal).toLocaleString("sv-SE");
    ctx.fillText(label, 6, y+4);
    ctx.globalAlpha = 0.35;
  }

  // zero axis
  ctx.globalAlpha = 0.9;
  ctx.strokeStyle = "#94a3b8";
  ctx.beginPath();
  ctx.moveTo(padL, yScale(0));
  ctx.lineTo(padL + plotW, yScale(0));
  ctx.stroke();

  // bars
  const barGap = 8;
  const barW = (plotW - barGap*11) / 12;
  const months = ["Jan","Feb","Mar","Apr","Maj","Jun","Jul","Aug","Sep","Okt","Nov","Dec"];

  for (let i=0;i<12;i++){
    const v = monthlyNet[i];
    const x = padL + i*(barW + barGap);
    const y0 = yScale(0);
    const yv = yScale(v);
    const top = Math.min(y0, yv);
    const bh = Math.abs(y0 - yv);

    // color: green for positive, red for negative
    ctx.globalAlpha = 0.95;
    ctx.fillStyle = v >= 0 ? "#22c55e" : "#ef4444";
    ctx.fillRect(x, top, barW, Math.max(1, bh));

    // month labels
    ctx.globalAlpha = 0.8;
    ctx.fillStyle = "#cbd5e1";
    ctx.font = "12px system-ui, -apple-system, Segoe UI, Roboto, Arial";
    ctx.fillText(months[i], x + 4, h - 12);
  }

  // line over bars
  ctx.globalAlpha = 0.95;
  ctx.strokeStyle = "#60a5fa";
  ctx.lineWidth = 2;
  ctx.beginPath();
  for (let i=0;i<12;i++){
    const v = monthlyNet[i];
    const x = padL + i*(barW + barGap) + barW/2;
    const y = yScale(v);
    if (i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  }
  ctx.stroke();
}

function updateNetChart() {
  const canvas = document.getElementById("netChart");
  if (!canvas) return;

  ensureNetYearOptions();
  const year = Number(document.getElementById("netYear")?.value || new Date().getFullYear());

  // simple hash to avoid redraw spam
  const hash = (data || []).length + "|" + year;
  if (_netChartCache.year === year && _netChartCache.dataHash === hash) return;
  _netChartCache = { year, dataHash: hash };

  const monthlyNet = computeMonthlyNet(year);
  drawNetChart(canvas, monthlyNet);
}
// ============================================================================


function renderInv() {
  const holdings = getHoldings();
  const totCost  = holdings.reduce((s,h) => s+h.cost, 0);
  const totVal   = holdings.reduce((s,h) => s+h.val,  0);
  const gainKr   = totVal - totCost;
  const gainPct  = totCost > 0 ? (gainKr/totCost*100) : 0;
  const isPos    = gainKr >= 0;

  document.getElementById('invTotVal').textContent  = fmt(totVal);
  document.getElementById('invValNote').textContent = totCost > 0 ? (isPos ? '‚Üë V√§rde√∂kning' : '‚Üì V√§rdeminskning') : '‚Äì';
  document.getElementById('investBadgeValue').textContent = fmt(totCost);

  const gkEl = document.getElementById('invTotGainKr');
  const gpEl = document.getElementById('invTotGainPct');
  gkEl.textContent = (isPos?'+':'‚àí') + fmt(Math.abs(gainKr));
  gpEl.textContent = (isPos?'+':'') + gainPct.toFixed(2) + '%';
  gkEl.className   = 'card-value ' + (isPos?'pos':'neg2');
  gpEl.className   = 'card-value ' + (isPos?'pos':'neg2');
  document.getElementById('invGainCard').querySelector('.card-label').style.color = isPos?'var(--green)':'var(--red)';
  document.getElementById('invPctCard').querySelector('.card-label').style.color  = isPos?'var(--green)':'var(--red)';

  const tbody = document.getElementById('invBody');
  const empty = document.getElementById('invEmpty');
  if (!invData.length) { tbody.innerHTML=''; empty.style.display='block'; drawChart(); return; }
  empty.style.display = 'none';

  const sorted = holdings.sort((a,b) => {
    const gainA = a.val - a.cost;
    const gainB = b.val - b.cost;
    return gainB - gainA;
  });
  tbody.innerHTML = sorted.map(h => {
    const gKr  = h.val - h.cost;
    const gPct = h.cost > 0 ? (gKr/h.cost*100) : 0;
    const pos  = gKr >= 0; const zero = gKr === 0;
    const pctCls = zero?'zero':pos?'pos':'neg';
    const amtCls = zero?'neutral':pos?'pos':'neg2';
    const arrow  = zero?'‚Üí':pos?'‚ñ≤':'‚ñº';
    // Find earliest purchase date for this holding
    const purchases = invData.filter(p => p.name.toLowerCase() === h.name.toLowerCase());
    const earliestDate = purchases.reduce((min, p) => !min || p.date < min ? p.date : min, '');
    return `<tr>
      <td class="name">${esc(h.name)}</td>
      <td class="num" style="color:var(--muted)">${fmt(h.cost)}</td>
<td class="num ${amtCls}">${arrow} ${fmt(Math.abs(gKr))} <span style="opacity:0.7;font-size:0.9em">(${pos?'+':''}${gPct.toFixed(1)}%)</span></td>
      <td>
        <button class="del" onclick="toggleEdit('${esc(h.name)}')" title="Redigera v√§rde" style="color:var(--blue);margin-right:4px">‚úé</button>
        <button class="del" data-name="${esc(h.name)}" onclick="delHoldingBtn(this)" title="Ta bort alla k√∂p">‚úï</button>
      </td>
    </tr>`;
  }).join('');
  drawChart();
  drawStockCharts();
}
function getAutoVal(year, monthIdx) {
  const ym = `${year}-${String(monthIdx+1).padStart(2,'0')}`;
  const purchases = invData.filter(p => p.date && p.date.slice(0,7) <= ym);
  if (!purchases.length) return null;
  return purchases.reduce((s,p) => s + p.cost, 0);
}

function getAutoPortVal(year, monthIdx) {
  const ym = `${year}-${String(monthIdx+1).padStart(2,'0')}`;
  const purchases = invData.filter(p => p.date && p.date.slice(0,7) <= ym);
  if (!purchases.length) return null;
  return purchases.reduce((sum, p) => sum + (Number(p.val) || 0), 0);
}


function getMonthData(year) {
  const yk = String(year);
  if (!chartData[yk]) chartData[yk] = Array(12).fill(null).map(() => ({ val: '' }));
  return chartData[yk];
}

function changeChartYear(delta) {
  chartYear += delta;
  document.getElementById('chartYearLabel').textContent = chartYear;
  buildMonthInputs();
  drawChart();
}

function buildMonthInputs() {
  const grid = document.getElementById('monthInputGrid');
  if (!grid) return;
  const months  = getMonthData(chartYear);
  const holdings = getHoldings();
  const totVal  = holdings.reduce((s,h) => s + h.val, 0);
  const nowYM   = new Date().toISOString().slice(0,7);

  grid.innerHTML = MONTHS.map((m, i) => {
    const ym        = `${chartYear}-${String(i+1).padStart(2,'0')}`;
    const autoV     = getAutoPortVal(chartYear, i);
    const isNowMon  = ym === nowYM;
    const hasManual = months[i].val !== '';
    // Current month: auto-fill with live totVal unless user has overridden (summerat fr√•n investeringar)
    const isLive    = isNowMon && totVal > 0 && !hasManual;
    const rawVal    = hasManual ? months[i].val : (isLive ? Math.round(totVal) : (autoV !== null ? Math.round(autoV) : ''));
    const displayVal = rawVal ? Math.round(rawVal).toLocaleString('sv-SE') : '';

    let ph, badge;
    if (hasManual) {
      badge = '';
      ph = '';
    } else if (isLive) {
      badge = '<span style="color:#22c55e;font-size:.65rem">LIVE</span>';
      ph = '';
    } else if (autoV !== null) {
      badge = '<span style="color:#7c3aed;font-size:.65rem">AUTO</span>';
      ph = `${Math.round(autoV).toLocaleString('sv-SE')} kr`;
    } else {
      badge = '';
      ph = '0 kr';
    }

    const borderStyle = isLive
      ? 'border-color:#22c55e80'
      : (!hasManual && autoV !== null ? 'border-color:#7c3aed50' : '');

    return `<div class="month-cell" style="${borderStyle}">
      <div class="month-cell-label" style="display:flex;justify-content:space-between">
        <span>${m}</span>${badge}
      </div>
      <input type="text" inputmode="numeric" pattern="[0-9 ]*"
        value="${displayVal}"
        placeholder="${ph}"
        oninput="updateMonthVal(${i}, this.value.replace(/\\s/g,''))"
        onfocus="this.select()"/>
    </div>`;
  }).join('');
}

function updateMonthVal(idx, value) {
  const yk = String(chartYear);
  if (!chartData[yk]) chartData[yk] = Array(12).fill(null).map(() => ({ val: '' }));
  chartData[yk][idx].val = value === '' ? '' : parseFloat(value) || 0;
  saveChartData();
  buildMonthInputs();
  drawChart();
}


function showTT(e, i, val, cost) {
  const tt   = document.getElementById('chartTooltip');
  const gain = val - cost;
  const pct  = cost > 0 ? (gain/cost*100) : 0;
  const pos  = gain >= 0;
  document.getElementById('ttMonth').textContent = MONTHS[i] + ' ' + chartYear;
  document.getElementById('ttCost').textContent  = fmt(cost);
  document.getElementById('ttVal').textContent   = fmt(val);
  const ge = document.getElementById('ttGain');
  ge.textContent = (pos?'+':'‚àí') + fmt(Math.abs(gain)) + '  (' + (pos?'+':'') + pct.toFixed(2) + '%)';
  ge.style.color = pos ? '#22c55e' : '#ef4444';
  tt.style.left  = (e.clientX + 14) + 'px';
  tt.style.top   = (e.clientY - 80) + 'px';
  tt.classList.add('show');
}

function hideTT() {
  document.getElementById('chartTooltip').classList.remove('show');
}

function initChart() {
  document.getElementById('chartYearLabel').textContent = chartYear;
  buildMonthInputs();
  drawChart();
}

window.addEventListener('resize', () => { drawChart(); drawSavingsChart(); drawIncomeMiniChart(); drawStockCharts(); });

// =================== SAVINGS ===================
let savingsData = []; // [{month:'2025-01', val:12000}, ...]
let _savSaveT = null;

async function loadSavings() {
  const { data: u } = await supabase.auth.getUser();
  const user_id = u.user?.id;
  if (!user_id) return;
  const { data: rows } = await supabase.from('savings_account').select('month,val').order('month', { ascending: true });
  savingsData = (rows || []).map(r => ({ month: r.month, val: Number(r.val) }));
}

async function persistSavings() {
  const { data: u } = await supabase.auth.getUser();
  const user_id = u.user?.id;
  if (!user_id) return;
  await supabase.from('savings_account').delete().eq('user_id', user_id);
  if (savingsData.length) {
    await supabase.from('savings_account').insert(savingsData.map(r => ({ user_id, month: r.month, val: r.val })));
  }
}

function saveSavings() {
  clearTimeout(_savSaveT);
  _savSaveT = setTimeout(async () => { try { await persistSavings(); } catch(e){ console.warn(e); } }, 300);
}

async function addSavings() {
  const amtEl = document.getElementById('savAmt');
  const monEl = document.getElementById('savMonth');
  const val = parseFloat(amtEl.value);
  const month = monEl.value;
  if (!month || isNaN(val) || val < 0) {
    if (!month) { monEl.classList.add('error'); setTimeout(()=>monEl.classList.remove('error'),400); }
    if (isNaN(val)||val<0) { amtEl.classList.add('error'); setTimeout(()=>amtEl.classList.remove('error'),400); }
    return;
  }
  const existing = savingsData.findIndex(r => r.month === month);
  if (existing >= 0) savingsData[existing].val = val;
  else savingsData.push({ month, val });
  savingsData.sort((a,b) => a.month.localeCompare(b.month));
  saveSavings();
  renderSavings();
  amtEl.value = '';
  showToast('‚úì Sparkonto uppdaterat', 'green');
}

function renderSavings() {
  const cur = savingsData.length ? savingsData[savingsData.length-1] : null;
  const prev = savingsData.length > 1 ? savingsData[savingsData.length-2] : null;
  document.getElementById('savCurrentVal').textContent = cur ? fmt(cur.val) : '‚Äì';
  if (cur && prev) {
    const diff = cur.val - prev.val;
    const el = document.getElementById('savLastChange');
    el.textContent = (diff >= 0 ? '+' : '‚Äì') + fmt(Math.abs(diff));
    el.style.color = diff >= 0 ? 'var(--green)' : 'var(--red)';
  } else {
    document.getElementById('savLastChange').textContent = '‚Äì';
  }
  document.getElementById('savLastDate').textContent = cur ? cur.month : '‚Äì';
  drawSavingsChart();
}

function drawSavingsChart() {
  const canvas = document.getElementById('savingsChart');
  if (!canvas || !savingsData.length) return;
  const dpr = window.devicePixelRatio || 1;
  const dispW = canvas.offsetWidth || 300;
  const dispH = 90;
  canvas.width = dispW * dpr;
  canvas.height = dispH * dpr;
  canvas.style.width = dispW + 'px';
  canvas.style.height = dispH + 'px';
  const ctx = canvas.getContext('2d');
  ctx.scale(dpr, dpr);
  ctx.clearRect(0, 0, dispW, dispH);

  const vals = savingsData.map(r => r.val);
  const maxV = Math.max(...vals) * 1.1 || 1;
  const minV = Math.min(...vals) * 0.9;
  const range = maxV - minV || 1;
  const padL = 8, padR = 8, padT = 10, padB = 22;
  const w = dispW - padL - padR;
  const h = dispH - padT - padB;
  const n = vals.length;
  const xP = i => padL + (n === 1 ? w/2 : (i/(n-1)) * w);
  const yP = v => padT + h - ((v - minV) / range) * h;

  // gradient fill
  const grad = ctx.createLinearGradient(0, padT, 0, padT + h);
  grad.addColorStop(0, 'rgba(34,211,238,.25)');
  grad.addColorStop(1, 'rgba(34,211,238,.01)');
  ctx.beginPath();
  ctx.moveTo(xP(0), yP(minV));
  vals.forEach((v,i) => ctx.lineTo(xP(i), yP(v)));
  ctx.lineTo(xP(n-1), yP(minV));
  ctx.closePath();
  ctx.fillStyle = grad;
  ctx.fill();

  // line
  ctx.beginPath();
  vals.forEach((v,i) => { if(i===0) ctx.moveTo(xP(i),yP(v)); else ctx.lineTo(xP(i),yP(v)); });
  ctx.strokeStyle = '#22d3ee';
  ctx.lineWidth = 2;
  ctx.stroke();

  // dots + month labels
  savingsData.forEach((r,i) => {
    ctx.beginPath();
    ctx.arc(xP(i), yP(r.val), 3, 0, Math.PI*2);
    ctx.fillStyle = '#22d3ee';
    ctx.fill();
    ctx.fillStyle = '#94a3b8';
    ctx.font = `${Math.max(9, Math.floor(w/(n*1.8)))}px Inter,Arial`;
    ctx.textAlign = 'center';
    ctx.fillText(r.month.slice(5), xP(i), dispH - 4);
  });
}

// =================== INCOME MINI CHART ===================
function renderIncomeOverview() {
  const now2 = new Date();
  const thisYM = now2.toISOString().slice(0,7);
  const incTx = data.filter(t => t.type === 'income');
  const total = incTx.reduce((s,t)=>s+t.amt,0);
  const thisMonth = incTx.filter(t=>t.date.startsWith(thisYM)).reduce((s,t)=>s+t.amt,0);

  // group by month
  const byMonth = {};
  incTx.forEach(t => {
    const ym = t.date.slice(0,7);
    byMonth[ym] = (byMonth[ym]||0) + t.amt;
  });
  const months = Object.keys(byMonth).sort();
  const avg = months.length ? total / months.length : 0;
  const bestM = months.reduce((best,m)=> (!best||byMonth[m]>byMonth[best]?m:best), '');

  document.getElementById('incTotalAll').textContent = fmt(total);
  document.getElementById('incThisMonth').textContent = fmt(thisMonth);
  document.getElementById('incAvgMonth').textContent = fmt(Math.round(avg));
  document.getElementById('incBestMonth').textContent = bestM ? `${bestM} (${fmt(byMonth[bestM])})` : '‚Äì';

  drawIncomeMiniChart(byMonth, months);
}

function drawIncomeMiniChart(byMonth, months) {
  if (!byMonth) {
    const bm = {};
    data.filter(t=>t.type==='income').forEach(t=>{ const ym=t.date.slice(0,7); bm[ym]=(bm[ym]||0)+t.amt; });
    months = Object.keys(bm).sort();
    byMonth = bm;
  }
  const canvas = document.getElementById('incomeBarChart');
  if (!canvas || !months || !months.length) return;
  const dpr = window.devicePixelRatio || 1;
  const dispW = canvas.offsetWidth || 300;
  const dispH = 90;
  canvas.width = dispW * dpr;
  canvas.height = dispH * dpr;
  canvas.style.width = dispW + 'px';
  canvas.style.height = dispH + 'px';
  const ctx = canvas.getContext('2d');
  ctx.scale(dpr, dpr);
  ctx.clearRect(0, 0, dispW, dispH);

  const vals = months.map(m => byMonth[m]);
  const maxV = Math.max(...vals, 1);
  const padL = 8, padR = 8, padT = 6, padB = 20;
  const w = dispW - padL - padR;
  const h = dispH - padT - padB;
  const n = months.length;
  const barW = Math.max(4, (w / n) - 4);
  const xP = i => padL + i * (w/n) + (w/n - barW)/2;

  vals.forEach((v,i) => {
    const bh = (v/maxV) * h;
    ctx.fillStyle = '#22c55e';
    ctx.globalAlpha = 0.8;
    ctx.beginPath();
    ctx.roundRect(xP(i), padT + h - bh, barW, bh, 3);
    ctx.fill();
    ctx.globalAlpha = 0.6;
    ctx.fillStyle = '#94a3b8';
    ctx.font = `${Math.max(8, Math.floor(w/(n*2)))}px Inter,Arial`;
    ctx.textAlign = 'center';
    ctx.fillText(months[i].slice(5), xP(i) + barW/2, dispH - 4);
  });
}

// =================== PER-STOCK CHARTS ===================
let activeStockTab = null;

function drawStockCharts() {
  const holdings = getHoldings();
  const tabsEl = document.getElementById('stockTabs');
  const panelsEl = document.getElementById('stockChartPanels');
  if (!tabsEl || !panelsEl) return;

  if (!holdings.length) {
    tabsEl.innerHTML = '<span style="color:var(--dim);font-size:.82rem">L√§gg till investeringar f√∂r att se diagram per aktie</span>';
    panelsEl.innerHTML = '';
    return;
  }

  // Build tabs if not already matching
  if (tabsEl.children.length !== holdings.length || activeStockTab === null) {
    if (!holdings.find(h=>h.name===activeStockTab)) activeStockTab = holdings[0].name;
    tabsEl.innerHTML = holdings.map(h => `
      <button class="stock-tab${h.name===activeStockTab?' active':''}" onclick="setActiveStockTab(${JSON.stringify(h.name)})">${h.name}</button>
    `).join('');
    panelsEl.innerHTML = holdings.map(h => `
      <div class="stock-chart-panel${h.name===activeStockTab?' active':''}" id="scp-${h.name.replace(/\s/g,'_')}">
        <div style="display:flex;align-items:center;gap:14px;margin-bottom:10px;flex-wrap:wrap">
          <span style="font-weight:700;font-size:1.05rem">${h.name}</span>
          ${buildStockStats(h)}
        </div>
        <canvas id="scv-${h.name.replace(/\s/g,'_')}" height="160" style="width:100%;border-radius:10px;background:rgba(0,0,0,.1)"></canvas>
      </div>
    `).join('');
  } else {
    // Just update active class
    Array.from(tabsEl.children).forEach((btn,i) => {
      btn.className = 'stock-tab' + (holdings[i].name===activeStockTab?' active':'');
    });
    Array.from(panelsEl.children).forEach((p,i) => {
      p.className = 'stock-chart-panel' + (holdings[i].name===activeStockTab?' active':'');
    });
    // Update stats
    holdings.forEach(h => {
      const panel = document.getElementById('scp-'+h.name.replace(/\s/g,'_'));
      if (panel) {
        const statsEl = panel.querySelector('.stock-stats-wrap');
        if (statsEl) statsEl.innerHTML = buildStockStats(h);
      }
    });
  }

  // Draw canvas for active
  const activeH = holdings.find(h=>h.name===activeStockTab);
  if (activeH) drawSingleStockChart(activeH);
}

function buildStockStats(h) {
  const gain = h.val - h.cost;
  const pct = h.cost > 0 ? (gain/h.cost*100) : 0;
  const pos = gain >= 0;
  return `<span class="stock-stats-wrap" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
    <span style="color:var(--muted);font-size:.82rem">Investerat: <strong style="color:var(--text)">${fmt(h.cost)}</strong></span>
    <span style="color:var(--muted);font-size:.82rem">V√§rde: <strong style="color:var(--text)">${fmt(h.val)}</strong></span>
    <span class="gain-pill ${pos?'pos':'neg'}">${pos?'‚ñ≤':'‚ñº'} ${fmt(Math.abs(gain))} (${pos?'+':''}${pct.toFixed(2)}%)</span>
  </span>`;
}

function drawSingleStockChart(h) {
  const canvasId = 'scv-' + h.name.replace(/\s/g,'_');
  const canvas = document.getElementById(canvasId);
  if (!canvas) return;

  // Build timeline: get all purchase dates for this holding, month by month
  const purchases = invData.filter(p => p.name.toLowerCase() === h.name.toLowerCase());
  if (!purchases.length) return;

  const firstDate = purchases.reduce((min,p)=>(!min||p.date<min?p.date:min),'');
  const firstYM = firstDate.slice(0,7);
  const nowYM = new Date().toISOString().slice(0,7);

  // Build month range
  const monthRange = [];
  let cur = firstYM;
  while (cur <= nowYM) {
    monthRange.push(cur);
    const [y,m] = cur.split('-').map(Number);
    const next = m===12 ? `${y+1}-01` : `${y}-${String(m+1).padStart(2,'0')}`;
    cur = next;
    if (monthRange.length > 60) break; // max 5 years
  }

  // For each month: cumulative invested, current val (latest purchase val for that month)
  const points = monthRange.map(ym => {
    const cumPurchases = purchases.filter(p=>p.date.slice(0,7)<=ym);
    const cost = cumPurchases.reduce((s,p)=>s+p.cost,0);
    // Val: use current val if it's the current month, otherwise use val from purchases up to that month
    const isNow = ym === nowYM;
    let val;
    if (isNow) {
      val = h.val; // live
    } else {
      const lastP = [...cumPurchases].sort((a,b)=>a.date.localeCompare(b.date)).pop();
      val = lastP ? lastP.val : 0;
    }
    return { ym, cost, val };
  });

  const dpr = window.devicePixelRatio || 1;
  const dispW = canvas.offsetWidth || 400;
  const dispH = 160;
  canvas.width = dispW * dpr;
  canvas.height = dispH * dpr;
  canvas.style.width = dispW + 'px';
  canvas.style.height = dispH + 'px';
  const ctx = canvas.getContext('2d');
  ctx.scale(dpr, dpr);
  ctx.clearRect(0, 0, dispW, dispH);

  const costs = points.map(p=>p.cost);
  const vals = points.map(p=>p.val);
  const allVals = [...costs, ...vals, 0];
  const maxV = Math.max(...allVals) * 1.1 || 1;
  const minV = 0;
  const range = maxV - minV || 1;
  const padL = 52, padR = 12, padT = 12, padB = 24;
  const w = dispW - padL - padR;
  const h2 = dispH - padT - padB;
  const n = points.length;
  const xP = i => padL + (n<=1?w/2:(i/(n-1))*w);
  const yP = v => padT + h2 - ((v-minV)/range)*h2;

  // Grid lines
  [0,.25,.5,.75,1].forEach(t => {
    const v = minV + range*t;
    const y = yP(v);
    ctx.strokeStyle = 'rgba(100,116,139,.2)';
    ctx.lineWidth = 1;
    ctx.beginPath(); ctx.moveTo(padL,y); ctx.lineTo(padL+w,y); ctx.stroke();
    ctx.fillStyle='#64748b'; ctx.font='10px Inter,Arial'; ctx.textAlign='right';
    const lbl = v>=1e6?(v/1e6).toFixed(1)+'M':v>=1e3?Math.round(v/1e3)+'k':Math.round(v)+'';
    ctx.fillText(lbl, padL-4, y+4);
  });

  // Cost area (invested)
  const costGrad = ctx.createLinearGradient(0,padT,0,padT+h2);
  costGrad.addColorStop(0,'rgba(124,58,237,.15)');
  costGrad.addColorStop(1,'rgba(124,58,237,.01)');
  ctx.beginPath();
  ctx.moveTo(xP(0),yP(0));
  costs.forEach((v,i)=>ctx.lineTo(xP(i),yP(v)));
  ctx.lineTo(xP(n-1),yP(0)); ctx.closePath();
  ctx.fillStyle = costGrad; ctx.fill();
  // Cost line
  ctx.beginPath();
  costs.forEach((v,i)=>{ if(i===0) ctx.moveTo(xP(i),yP(v)); else ctx.lineTo(xP(i),yP(v)); });
  ctx.strokeStyle='#7c3aed'; ctx.lineWidth=1.5; ctx.setLineDash([5,3]); ctx.stroke(); ctx.setLineDash([]);

  // Val area
  const valGrad = ctx.createLinearGradient(0,padT,0,padT+h2);
  valGrad.addColorStop(0,'rgba(34,197,94,.18)');
  valGrad.addColorStop(1,'rgba(34,197,94,.01)');
  ctx.beginPath();
  ctx.moveTo(xP(0),yP(0));
  vals.forEach((v,i)=>ctx.lineTo(xP(i),yP(v)));
  ctx.lineTo(xP(n-1),yP(0)); ctx.closePath();
  ctx.fillStyle=valGrad; ctx.fill();
  // Val line
  ctx.beginPath();
  vals.forEach((v,i)=>{ if(i===0) ctx.moveTo(xP(i),yP(v)); else ctx.lineTo(xP(i),yP(v)); });
  ctx.strokeStyle='#22c55e'; ctx.lineWidth=2.5; ctx.stroke();

  // Dots
  vals.forEach((v,i)=>{
    const pos = v >= costs[i];
    ctx.beginPath(); ctx.arc(xP(i),yP(v),3,0,Math.PI*2);
    ctx.fillStyle=pos?'#22c55e':'#ef4444'; ctx.fill();
  });

  // X labels (show every Nth)
  const step = Math.max(1, Math.ceil(n/8));
  points.forEach((p,i) => {
    if (i%step!==0 && i!==n-1) return;
    ctx.fillStyle='#64748b'; ctx.font='10px Inter,Arial'; ctx.textAlign='center';
    ctx.fillText(p.ym.slice(5)+'/'+p.ym.slice(2,4), xP(i), dispH-5);
  });
}

function setActiveStockTab(name) {
  activeStockTab = name;
  drawStockCharts();
}

// =================== BOOT ===================
(async function boot() {
  const sessionOk = await checkSession();
  if (sessionOk) {
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('mainApp').style.display = 'block';
    try { await loadAllFromSupabase(); await loadSavings(); } catch(e){ console.warn(e); }
    render();
    updateNetChart();
    renderInv(); initChart();
    renderSavings();
    renderIncomeOverview();
    drawStockCharts();
    // Set default month for savings input
    document.getElementById('savMonth').value = new Date().toISOString().slice(0,7);
  }
})();



// Expose functions for inline onclick handlers
Object.assign(window, {
  updateNetChart, doLogin, doLogout, switchTab, add, del, editTx, render, clearFilter,
  addInv, delInv, changeChartYear, updateMonthVal, toggleEdit, delHoldingBtn,
  addSavings, setActiveStockTab });
window.switchTab = switchTab;
</script>
</body>
</html>
